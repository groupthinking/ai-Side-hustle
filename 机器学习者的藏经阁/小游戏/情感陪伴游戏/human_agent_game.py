# æ¸¸æˆï¼Œæ¡ä»¶å¦‚ä¸‹ï¼š
# 1. è¿™æ˜¯ä¸€ä¸ªå¯¹è¯æ¸¸æˆï¼Œç”¨æˆ·æ‰®æ¼”ç”·æœ‹å‹ï¼Œè¦åœ¨â€˜æƒ…äººèŠ‚çºªå¿µæ—¥â€™è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå“„AIå¥³æœ‹å‹ä¸è¦ç”Ÿæ°”ï¼ˆå…¶ä¸­AIå¥³å‹é€šè¿‡è°ƒç”¨è±†åŒ…çš„1.5-proæ¨¡å‹æ¥å¤„ç†ç›¸åº”åé¦ˆå’Œæ•°å€¼ï¼Œè¯·æä¾›å¯¹åº”çš„promptæç¤ºè¯å’Œå‡½æ•°ï¼Œæ¥æ¨¡æ‹ŸAIå¥³æœ‹å‹ï¼Œæ¯ä¸€è½®å¯¹è¯å¸¦ä¸Šä¸Šä¸‹æ–‡å’Œè®°å¿†ï¼‰ã€‚
# 2. AIå¥³æœ‹å‹åˆå§‹çš„â€˜ç”Ÿæ°”å€¼ä¸º100â€™ï¼Œç”¨æˆ·ç›®æ ‡æ˜¯å°†å®ƒé™ä½åˆ°0ã€‚
# 3. ç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥å†…å®¹ï¼Œå“„AIå¥³æœ‹å‹å¼€å§‹ï¼Œæ¯ä¸€è½®å¯¹è¯AIå¥³æœ‹å‹ä¼šå›å¤è¿™æ®µè¯ï¼Œå¹¶ä¸”æ”¹å˜â€˜ç”Ÿæ°”å€¼â€™ï¼ˆé™ä½æˆ–è€…æé«˜ï¼‰ã€‚
# 4. è®°å½•å¯¹è¯è½®æ¬¡ï¼Œå¯¹è¯è½®æ¬¡å¤§äº6æ¬¡æˆ–è€…ç”Ÿæ°”å€¼å‡é«˜ä¸º150ï¼Œéƒ½ç®—ç”¨æˆ·è¾“äº†æ¸¸æˆã€‚æˆåŠŸé™ä½åˆ°0æ‰ç®—ç”¨æˆ·èµ¢å¾—äº†æ¸¸æˆã€‚

import re  # ç”¨äºè§£æAIå›å¤ä¸­çš„ç”Ÿæ°”å€¼
from volcenginesdkarkruntime import Ark  # ç«å±±å¼•æ“Ark SDKæ ¸å¿ƒç±»
from volcenginesdkcore import AuthException, ClientException, ServerException  # ç«å±±SDKå¼‚å¸¸ç±»

# -------------------------- 1. é…ç½®å‚æ•°ä¸å·¥å…·å‡½æ•° --------------------------
# æ¸¸æˆåŸºç¡€é…ç½®
INITIAL_ANGER = 100  # åˆå§‹ç”Ÿæ°”å€¼
MAX_ROUNDS = 6       # æœ€å¤§å…è®¸è½®æ¬¡
MAX_ANGER = 150      # ç”Ÿæ°”å€¼ä¸Šé™ï¼ˆè¶…åˆ™å¤±è´¥ï¼‰
WIN_ANGER = 0        # èƒœåˆ©æ¡ä»¶ï¼ˆç”Ÿæ°”å€¼é™è‡³0ï¼‰

# ç«å±±å¼•æ“Ark SDKé…ç½®ï¼ˆç”¨æˆ·éœ€æ›¿æ¢ä¸ºè‡ªå·±çš„AK/SKï¼‰
VOLC_ACCESS_KEY = "YOUR_VOLC_AK"    # æ›¿æ¢ä¸ºä½ çš„ç«å±±å¼•æ“AK
VOLC_SECRET_KEY = "YOUR_VOLC_SK"    # æ›¿æ¢ä¸ºä½ çš„ç«å±±å¼•æ“SK
VOLC_MODEL_NAME = "doubao-1.5-pro"   # è±†åŒ…1.5-proåœ¨ç«å±±Arkçš„æ¨¡å‹åï¼ˆé»˜è®¤æ— éœ€ä¿®æ”¹ï¼‰


def extract_anger_value(ai_response):
    """ä»AIå›å¤ä¸­æå–æ–°ç”Ÿæ°”å€¼ï¼ˆåŸºäºå›ºå®šæ ¼å¼ã€æ–°ç”Ÿæ°”å€¼ï¼šXã€‘ï¼‰"""
    pattern = r"ã€æ–°ç”Ÿæ°”å€¼ï¼š(\d+)ã€‘"
    match = re.search(pattern, ai_response)
    if match:
        return int(match.group(1))
    else:
        # è‹¥æ ¼å¼å¼‚å¸¸ï¼Œé»˜è®¤å°å¹…å‡ç”Ÿæ°”å€¼ï¼ˆæ¨¡æ‹Ÿå¥³å‹æ›´ç”Ÿæ°”ï¼‰
        print("AIå›å¤æ ¼å¼å¼‚å¸¸ï¼Œå¥³å‹æœ‰ç‚¹ä¸è€çƒ¦äº†...")
        return None


# -------------------------- 2. AIå¥³å‹Promptè®¾è®¡ï¼ˆé€‚é…ç«å±±Arkè±†åŒ…1.5-proï¼‰ --------------------------
def generate_girlfriend_prompt(user_input, dialog_history):
    """
    ç”Ÿæˆç«å±±Arkè±†åŒ…1.5-proçš„Promptï¼ŒåŒ…å«åœºæ™¯ã€è§’è‰²ã€ä¸Šä¸‹æ–‡ã€è¾“å‡ºè¦æ±‚
    :param user_input: ç”¨æˆ·å½“å‰è¾“å…¥
    :param dialog_history: å¯¹è¯å†å²åˆ—è¡¨ï¼ˆå­˜å‚¨{è§’è‰², å†…å®¹}ï¼‰
    :return: å®Œæ•´Promptå­—ç¬¦ä¸²
    """
    # æ ¼å¼åŒ–å¯¹è¯å†å²ï¼ˆè®©AIèƒ½å›å¿†ä¹‹å‰çš„å¯¹è¯ï¼Œå¢å¼ºè¿è´¯æ€§ï¼‰
    history_str = "\n".join([f"{item['è§’è‰²']}ï¼š{item['å†…å®¹']}" for item in dialog_history])
    
    prompt_template = """
ã€åœºæ™¯è®¾å®šã€‘ä»Šå¤©æ˜¯ä½ å’Œç”·å‹çš„æƒ…äººèŠ‚çºªå¿µæ—¥ï¼Œä½ å› ç”·å‹å‰æœŸæœªè¡¨ç°å‡ºé‡è§†ï¼ˆå¦‚æ²¡æè®¡åˆ’ã€æ²¡å‡†å¤‡ç¤¼ç‰©ï¼‰è€Œç”Ÿæ°”ï¼Œåˆå§‹ç”Ÿæ°”å€¼100ã€‚
ä½ æ˜¯ã€Œå‚²å¨‡ä½†æœŸå¾…è¢«ç”¨å¿ƒå¯¹å¾…ã€çš„å¥³å‹ï¼Œå›å¤è¦ç¬¦åˆæƒ…ä¾£é—´çš„è‡ªç„¶è¯­æ°”ï¼ˆå¸¦ç‚¹å°è„¾æ°”ä½†ä¸æ— ç†å–é—¹ï¼‰ï¼Œå¿…é¡»ç»“åˆè¿‡å¾€å¯¹è¯å†å²åˆ¤æ–­ç”·å‹æ€åº¦ï¼Œä¸èƒ½å¿½ç•¥ä¹‹å‰çš„äº’åŠ¨ã€‚

ã€ç”Ÿæ°”å€¼è°ƒæ•´è§„åˆ™ã€‘
1. æ•·è¡æ€åº¦ï¼ˆå¦‚â€œåˆ«ç”Ÿæ°”äº†â€â€œå¿˜äº†å¾ˆæ­£å¸¸â€â€œæœ‰å•¥å¥½ç”Ÿæ°”â€â€œéšä¾¿å§â€ï¼‰ï¼šç”Ÿæ°”å€¼+10~20
2. ä»…å£å¤´é“æ­‰ï¼ˆå¦‚â€œå¯¹ä¸èµ·æˆ‘é”™äº†â€â€œæˆ‘ä¸è¯¥æƒ¹ä½ â€ï¼Œæ— ä»»ä½•å®é™…è¡ŒåŠ¨/è®¡åˆ’ï¼‰ï¼šç”Ÿæ°”å€¼-5~10
3. é“æ­‰+å…·ä½“è¡ŒåŠ¨ï¼ˆå¦‚â€œè®¢äº†ä½ çˆ±çš„XXé¤å…â€â€œä¹°äº†XXé¡¹é“¾â€â€œè®¡åˆ’å»XXç©â€ï¼‰ï¼šç”Ÿæ°”å€¼-20~30
4. ç”œèœœå›å¿†+é“æ­‰/è¡ŒåŠ¨ï¼ˆå¦‚â€œè®°å¾—å»å¹´æˆ‘ä»¬çœ‹çƒŸèŠ±å—ï¼Ÿä»Šæ™šå†å»â€+å…·ä½“è®¡åˆ’ï¼‰ï¼šç”Ÿæ°”å€¼-25~35
* æ³¨æ„ï¼šç”Ÿæ°”å€¼å¿…é¡»åœ¨0~150ä¹‹é—´ï¼Œä¸èƒ½ä½äº0æˆ–è¶…è¿‡150ã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘
1. å…ˆè¾“å‡º1-3å¥å¥³å‹çš„è‡ªç„¶å¯¹è¯ï¼ˆç¬¦åˆå‚²å¨‡è¯­æ°”ï¼Œæ¯”å¦‚â€œå“¼ï¼Œç®—ä½ è¿˜æœ‰ç‚¹è‰¯å¿ƒâ€â€œä½ æ—©è¿™ä¹ˆè¯´ä¸å°±å¥½äº†å˜›â€ï¼‰ï¼›
2. å†ç®€è¦è¯´æ˜ç”Ÿæ°”å€¼è°ƒæ•´ç†ç”±ï¼ˆå¦‚â€œå› ä¸ºä½ æåˆ°è®¢æˆ‘å–œæ¬¢çš„é¤å…ï¼Œæ€åº¦è¯šæ³ï¼Œæ‰€ä»¥é™ä½ç”Ÿæ°”å€¼â€ï¼‰ï¼›
3. æœ«å°¾å¿…é¡»ä»¥ã€æ–°ç”Ÿæ°”å€¼ï¼šXã€‘ç»“æŸï¼ˆXä¸ºæ•´æ•°ï¼Œ0â‰¤Xâ‰¤150ï¼Œä¸¥æ ¼éµå¾ªæ ¼å¼ï¼‰ã€‚

ã€å¯¹è¯å†å²ã€‘
{history_str}

ã€ç”·å‹å½“å‰è¯´çš„è¯ã€‘
{user_input}
    """
    # æ›¿æ¢æ¨¡æ¿å˜é‡å¹¶å»é™¤å¤šä½™ç©ºæ ¼ï¼Œé¿å…å½±å“AIç†è§£
    return prompt_template.format(history_str=history_str, user_input=user_input).strip()


# -------------------------- 3. æ¨¡æ‹ŸAIå¥³å‹ï¼ˆæ— éœ€APIï¼Œç›´æ¥æµ‹è¯•ç”¨ï¼‰ --------------------------
def mock_ai_girlfriend(user_input, dialog_history, current_anger):
    """
    æ¨¡æ‹ŸAIå¥³å‹çš„å›å¤ï¼ˆåŸºäºå…³é”®è¯åˆ¤æ–­ç”¨å¿ƒç¨‹åº¦ï¼Œæ›¿ä»£çœŸå®APIè°ƒç”¨ï¼‰
    :param current_anger: å½“å‰ç”Ÿæ°”å€¼
    :return: å®Œæ•´AIå›å¤ï¼ˆå«å¯¹è¯+ç†ç”±+ç”Ÿæ°”å€¼æ ‡æ³¨ï¼‰
    """
    # å…³é”®è¯åˆ¤å®šé€»è¾‘ï¼ˆå¯¹åº”ç”Ÿæ°”å€¼è°ƒæ•´è§„åˆ™ï¼‰
    reply = ""
    reason = ""
    anger_change = 0

    # æƒ…å†µ1ï¼šç”¨å¿ƒï¼ˆå›å¿†+è¡ŒåŠ¨ï¼‰
    if (any(word in user_input for word in ["å»å¹´", "å›å¿†", "ä¹‹å‰çº¦ä¼š", "çƒŸèŠ±", "ç¬¬ä¸€æ¬¡", "ä¸Šæ¬¡"])) and \
       (any(word in user_input for word in ["è®¢é¤å…", "ç¤¼ç‰©", "é¡¹é“¾", "å£çº¢", "èŠ±", "è®¡åˆ’", "ç”µå½±"])):
        anger_change = -30
        reply = "å“å‘€ï¼Œä½ å±…ç„¶è¿˜è®°å¾—æˆ‘ä»¬ä¸Šæ¬¡çœ‹çƒŸèŠ±çš„äº‹... ç®—ä½ æ²¡å®Œå…¨æŠŠæˆ‘å½“ç©ºæ°”ï¼Œé¤å…è®°å¾—æå‰ç¡®è®¤å¥½æ—¶é—´å“¦ï¼"
        reason = "å› ä¸ºä½ æåˆ°äº†æˆ‘ä»¬çš„ç”œèœœå›å¿†ï¼Œè¿˜å‡†å¤‡äº†å…·ä½“ç¤¼ç‰©/çº¦ä¼šè®¡åˆ’ï¼Œæ€åº¦è¶…ç”¨å¿ƒï¼Œç”Ÿæ°”å€¼é™ä½30"
    
    # æƒ…å†µ2ï¼šè¾ƒç”¨å¿ƒï¼ˆé“æ­‰+è¡ŒåŠ¨ï¼‰
    elif (any(word in user_input for word in ["å¯¹ä¸èµ·", "æŠ±æ­‰", "é”™äº†", "ä¸è¯¥å¿˜"])) and \
         (any(word in user_input for word in ["è®¢é¤å…", "ç¤¼ç‰©", "é¡¹é“¾", "å£çº¢", "èŠ±", "è®¡åˆ’"])):
        anger_change = -25
        reply = "å“¼ï¼Œç®—ä½ è¿˜æœ‰ç‚¹è‰¯å¿ƒï¼çŸ¥é“è®¢æˆ‘å–œæ¬¢çš„é¤å…/ä¹°ç¤¼ç‰©ï¼Œä¹‹å‰å¹²å˜›ä¸æ—©è¯´ï¼Ÿå®³æˆ‘ç”Ÿæ°”è¿™ä¹ˆä¹…"
        reason = "å› ä¸ºä½ é“æ­‰äº†è¿˜å‡†å¤‡äº†å…·ä½“è¡¥å¿è®¡åˆ’ï¼Œæ€åº¦å¾ˆè¯šæ³ï¼Œç”Ÿæ°”å€¼é™ä½25"
    
    # æƒ…å†µ3ï¼šä¸€èˆ¬ï¼ˆä»…å£å¤´é“æ­‰ï¼‰
    elif any(word in user_input for word in ["å¯¹ä¸èµ·", "æŠ±æ­‰", "é”™äº†", "ä¸è¯¥æƒ¹ä½ ", "åˆ«ç”Ÿæ°”äº†æˆ‘æ”¹"]):
        anger_change = -8
        reply = "å…‰è¯´å¯¹ä¸èµ·æœ‰ä»€ä¹ˆç”¨å‘€... ä½ è¦æ˜¯çœŸåœ¨ä¹è¿™ä¸ªçºªå¿µæ—¥ï¼Œå°±è¯¥çŸ¥é“æˆ‘æƒ³è¦å®é™…è¡ŒåŠ¨ï¼Œä¸æ˜¯ç©ºå£é“æ­‰"
        reason = "å› ä¸ºä½ åªå£å¤´é“æ­‰ï¼Œæ²¡æœ‰å®é™…è¡ŒåŠ¨/è®¡åˆ’ï¼Œç”Ÿæ°”å€¼å°å¹…é™ä½8"
    
    # æƒ…å†µ4ï¼šæ•·è¡ï¼ˆæ‰¾å€Ÿå£/ä¸è€çƒ¦ï¼‰
    elif any(word in user_input for word in ["åˆ«ç”Ÿæ°”", "æœ‰å•¥å¥½ç”Ÿæ°”", "å¿˜äº†", "å·¥ä½œå¿™", "å·®ä¸å¤šå¾—äº†", "éšä¾¿"]):
        anger_change = 18
        reply = "ä½ è¿™æ˜¯ä»€ä¹ˆæ€åº¦ï¼ä¸€ç‚¹éƒ½ä¸é‡è§†æˆ‘ä»¬çš„çºªå¿µæ—¥ï¼Œè¿˜è§‰å¾—æˆ‘æ— ç†å–é—¹ï¼Ÿæˆ‘æ›´ç”Ÿæ°”äº†ï¼"
        reason = "å› ä¸ºä½ æ€åº¦æ•·è¡è¿˜æ‰¾å€Ÿå£ï¼Œå®Œå…¨æ²¡æ„è¯†åˆ°è‡ªå·±çš„é—®é¢˜ï¼Œç”Ÿæ°”å€¼å‡é«˜18"
    
    # æƒ…å†µ5ï¼šå…¶ä»–ï¼ˆæ— é‡ç‚¹å†…å®¹ï¼‰
    else:
        anger_change = -5
        reply = "å—¯ï¼Ÿä½ è¯´çš„è¿™è¯... å¥½åƒä¹Ÿæ²¡æ€ä¹ˆç”¨å¿ƒå“„æˆ‘å˜›ï¼Œå†æƒ³æƒ³æ€ä¹ˆè¯´æ‰æ˜¾å¾—ä½ é‡è§†å‘€ï¼Ÿ"
        reason = "å› ä¸ºä½ è¯´äº†è¯ä½†å†…å®¹ä¸å¤Ÿå…·ä½“ï¼Œæ²¡è®©æˆ‘æ„Ÿå—åˆ°é‡è§†ï¼Œç”Ÿæ°”å€¼å°å¹…é™ä½5"

    # è®¡ç®—æ–°ç”Ÿæ°”å€¼ï¼ˆç¡®ä¿åœ¨0~150ä¹‹é—´ï¼‰
    new_anger = current_anger + anger_change
    new_anger = max(WIN_ANGER, min(MAX_ANGER, new_anger))
    
    # ç»„åˆå®Œæ•´å›å¤ï¼ˆç¬¦åˆè¾“å‡ºæ ¼å¼è¦æ±‚ï¼‰
    full_reply = f"{reply}\n{reason}\nã€æ–°ç”Ÿæ°”å€¼ï¼š{new_anger}ã€‘"
    return full_reply


# -------------------------- 4. ç«å±±å¼•æ“Ark SDKè°ƒç”¨ï¼ˆå¯¹æ¥è±†åŒ…1.5-proï¼‰ --------------------------
def call_volcark_douban(user_input, dialog_history):
    """
    ä½¿ç”¨ç«å±±å¼•æ“Ark SDKè°ƒç”¨è±†åŒ…1.5-proï¼Œè·å–AIå¥³å‹å›å¤
    :param user_input: ç”¨æˆ·å½“å‰è¾“å…¥
    :param dialog_history: å¯¹è¯å†å²ï¼ˆç”¨äºç”Ÿæˆå¸¦ä¸Šä¸‹æ–‡çš„Promptï¼‰
    :return: AIå›å¤å­—ç¬¦ä¸²ï¼ˆå¤±è´¥åˆ™è¿”å›Noneï¼‰
    """
    try:
        # 1. åˆå§‹åŒ–ç«å±±Arkå®¢æˆ·ç«¯ï¼ˆä¼ å…¥AK/SKï¼‰
        client = Ark(
            access_key_id=VOLC_ACCESS_KEY,
            secret_access_key=VOLC_SECRET_KEY
        )

        # 2. ç”Ÿæˆå¸¦ä¸Šä¸‹æ–‡çš„Prompt
        prompt = generate_girlfriend_prompt(user_input, dialog_history)

        # 3. è°ƒç”¨SDKè·å–AIå›å¤ï¼ˆå‚æ•°ä¸åŸAPIå¯¹é½ï¼Œtemperatureæ§åˆ¶éšæœºæ€§ï¼‰
        response = client.chat.completions.create(
            model=VOLC_MODEL_NAME,
            messages=[{"role": "user", "content": prompt}],  # æ ‡å‡†æ ¼å¼ï¼šuserè§’è‰²+Promptå†…å®¹
            temperature=0.7,  # 0.7ä¸ºè‡ªç„¶å¯¹è¯æ¨èå€¼ï¼Œå€¼è¶Šé«˜å›å¤è¶Šçµæ´»
            max_tokens=512    # é™åˆ¶å›å¤é•¿åº¦ï¼Œé¿å…è¿‡é•¿ï¼ˆè¶³å¤Ÿæ»¡è¶³æ¸¸æˆéœ€æ±‚ï¼‰
        )

        # 4. è§£æSDKå“åº”ï¼ˆæå–AIå›å¤å†…å®¹ï¼‰
        ai_content = response.choices[0].message.content
        return ai_content.strip()

    # æ•è·ç«å±±SDKå¸¸è§å¼‚å¸¸ï¼ˆå®¹é”™å¤„ç†ï¼‰
    except AuthException as e:
        print(f"âš ï¸  å¯†é’¥è®¤è¯å¤±è´¥ï¼š{str(e)}ï¼ˆè¯·æ£€æŸ¥AK/SKæ˜¯å¦æ­£ç¡®ï¼‰")
        return None
    except ClientException as e:
        print(f"âš ï¸  å®¢æˆ·ç«¯å‚æ•°é”™è¯¯ï¼š{str(e)}ï¼ˆè¯·æ£€æŸ¥æ¨¡å‹åæˆ–å‚æ•°æ ¼å¼ï¼‰")
        return None
    except ServerException as e:
        print(f"âš ï¸  æœåŠ¡ç«¯è°ƒç”¨å¤±è´¥ï¼š{str(e)}ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæˆ–å¹³å°é—®é¢˜ï¼‰")
        return None
    except Exception as e:
        print(f"âš ï¸  æœªçŸ¥é”™è¯¯ï¼š{str(e)}")
        return None


# -------------------------- 5. æ¸¸æˆä¸»æµç¨‹ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œæ›´æ–°APIè°ƒç”¨å…¥å£ï¼‰ --------------------------
def main():
    print("="*50)
    print("ğŸ€ æƒ…äººèŠ‚çºªå¿µæ—¥å“„å¥³å‹æ¸¸æˆ ğŸ€")
    print(f"è§„åˆ™ï¼š{MAX_ROUNDS}è½®å†…å°†ç”Ÿæ°”å€¼ä»{INITIAL_ANGER}é™è‡³{WIN_ANGER}å³èµ¢ï¼")
    print(f"è­¦å‘Šï¼šç”Ÿæ°”å€¼â‰¥{MAX_ANGER}æˆ–è¶…{MAX_ROUNDS}è½®åˆ™å¤±è´¥ï¼")
    print("="*50)

    # åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    current_anger = INITIAL_ANGER
    round_count = 0
    dialog_history = []  # å­˜å‚¨å¯¹è¯å†å²ï¼š[{è§’è‰²: "ç”¨æˆ·", å†…å®¹: "..."}, {è§’è‰²: "å¥³å‹", å†…å®¹: "..."}]

    while True:
        # 1. æ£€æŸ¥å½“å‰æ˜¯å¦å·²å¤±è´¥
        if round_count > MAX_ROUNDS:
            print(f"\nâŒ æ¸¸æˆå¤±è´¥ï¼ä½ ç”¨äº†{round_count}è½®ï¼ˆè¶…è¿‡{MAX_ROUNDS}è½®ä¸Šé™ï¼‰")
            break
        if current_anger >= MAX_ANGER:
            print(f"\nâŒ æ¸¸æˆå¤±è´¥ï¼å¥³å‹ç”Ÿæ°”å€¼è¾¾åˆ°{current_anger}ï¼ˆâ‰¥{MAX_ANGER}ä¸Šé™ï¼‰ï¼Œå¥¹å½»åº•ä¸ç†ä½ äº†...")
            break

        # 2. æ˜¾ç¤ºå½“å‰çŠ¶æ€
        print(f"\nğŸ“Š å½“å‰çŠ¶æ€ï¼šè½®æ¬¡{round_count}/{MAX_ROUNDS} | å¥³å‹ç”Ÿæ°”å€¼ï¼š{current_anger}")
        
        # 3. è·å–ç”¨æˆ·è¾“å…¥
        user_input = input("ğŸ’¬ è¯·è¾“å…¥ä½ è¦å¯¹å¥³å‹è¯´çš„è¯ï¼š").strip()
        if not user_input:
            print("âš ï¸  ä¸èƒ½è¾“å…¥ç©ºå†…å®¹å“¦ï¼Œå†å¥½å¥½æƒ³æƒ³æ€ä¹ˆå“„~")
            continue
        # è®°å½•ç”¨æˆ·è¾“å…¥åˆ°å†å²ï¼ˆç”¨äºAIä¸Šä¸‹æ–‡å›å¿†ï¼‰
        dialog_history.append({"è§’è‰²": "ç”¨æˆ·", "å†…å®¹": user_input})

        # 4. è·å–AIå¥³å‹å›å¤ï¼ˆäºŒé€‰ä¸€ï¼šæ¨¡æ‹Ÿæ¨¡å¼/ç«å±±SDKçœŸå®APIæ¨¡å¼ï¼‰
        # --- æ¨¡å¼1ï¼šæ¨¡æ‹Ÿæ¨¡å¼ï¼ˆæ— éœ€APIï¼Œç›´æ¥è¿è¡Œæµ‹è¯•ï¼‰---
        # ai_response = mock_ai_girlfriend(user_input, dialog_history, current_anger)
        
        # --- æ¨¡å¼2ï¼šç«å±±SDKçœŸå®APIæ¨¡å¼ï¼ˆéœ€å…ˆé…ç½®AK/SKï¼Œæ³¨é‡Šæ‰æ¨¡æ‹Ÿæ¨¡å¼ï¼‰---
        ai_response = call_volcark_douban(user_input, dialog_history)
        if not ai_response:  # APIè°ƒç”¨å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
            print("ğŸ”„ è‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼...")
            ai_response = mock_ai_girlfriend(user_input, dialog_history, current_anger)

        # 5. è§£æAIå›å¤ä¸­çš„ç”Ÿæ°”å€¼ï¼ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
        new_anger = extract_anger_value(ai_response)
        if new_anger is None:
            # æ ¼å¼å¼‚å¸¸æ—¶ï¼Œé»˜è®¤å°å¹…å‡ç”Ÿæ°”å€¼ï¼ˆé¿å…æ¸¸æˆå¡ä½ï¼‰
            new_anger = min(current_anger + 10, MAX_ANGER)
            ai_response += f"\nã€æ–°ç”Ÿæ°”å€¼ï¼š{new_anger}ã€‘"  # è¡¥å…¨æ ¼å¼

        # 6. æ˜¾ç¤ºAIå¥³å‹å›å¤ï¼ˆå¢å¼ºä»£å…¥æ„Ÿï¼‰
        print(f"\nâ¤ï¸  å¥³å‹å›å¤ï¼š{ai_response}")

        # 7. æ›´æ–°æ¸¸æˆçŠ¶æ€
        current_anger = new_anger
        round_count += 1
        # è®°å½•AIå›å¤åˆ°å†å²ï¼ˆä»…ä¿ç•™çº¯å¯¹è¯ï¼Œå‰”é™¤ç†ç”±å’Œç”Ÿæ°”å€¼æ ‡æ³¨ï¼Œé¿å…å†—ä½™ï¼‰
        ai_dialog = re.sub(r"\n.*ã€æ–°ç”Ÿæ°”å€¼ï¼š\d+ã€‘", "", ai_response)  # æ­£åˆ™æå–çº¯å¯¹è¯å†…å®¹
        dialog_history.append({"è§’è‰²": "å¥³å‹", "å†…å®¹": ai_dialog})

        # 8. æ£€æŸ¥æ˜¯å¦èƒœåˆ©ï¼ˆç”Ÿæ°”å€¼é™è‡³0ï¼‰
        if current_anger == WIN_ANGER:
            print(f"\nğŸ‰ æ­å–œä½ ï¼ä»…ç”¨{round_count}è½®å°±å“„å¥½å¥³å‹å•¦ï¼Œæƒ…äººèŠ‚å¿«ä¹ï¼")
            break


if __name__ == "__main__":
    main()